<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.gbif.checklistbank.service.mybatis.mapper.RawUsageMapper">

  <resultMap id="rawResultMap" type="RawUsage" autoMapping="true">
    <id property="usageKey" column="usage_fk"/>
    <result property="data" column="smile"/>
    <result property="lastCrawled" column="downloaded"/>
  </resultMap>

  <!--  Get by primary key -->
  <select id="get" parameterType="map" resultMap="rawResultMap">
    SELECT r.*, m.downloaded
    FROM raw_usage r
      JOIN dataset_metrics m ON r.dataset_key=m.dataset_key AND m.latest
    WHERE usage_fk=#{key}
  </select>

  <insert id="insert" parameterType="RawUsage" useGeneratedKeys="false" keyProperty="usage_fk">
    INSERT INTO raw_usage (usage_fk, dataset_key, smile)
    VALUES  (#{r.usageKey}, #{r.datasetKey}, #{r.data})
  </insert>

  <update id="update" parameterType="RawUsage">
    UPDATE raw_usage SET smile = #{r.data}
    WHERE usage_fk = #{r.usageKey}
  </update>

</mapper>
