<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

  <changeSet id="1" author="markus">
    <sqlFile path="liquibase/clb2.sql"/>
  </changeSet>
  <changeSet id="2" author="markus">
    <sqlFile path="liquibase/col_feedback.sql"/>
  </changeSet>
  <changeSet id="3" author="markus">
    <sqlFile path="liquibase/dc_references.sql"/>
  </changeSet>
  <changeSet id="4" author="markus">
    <sqlFile path="liquibase/root_indices.sql"/>
  </changeSet>
  <changeSet id="5" author="markus">
    <sqlFile path="liquibase/del_nested_set.sql"/>
  </changeSet>
  <changeSet id="6" author="markus">
    <sqlFile path="liquibase/write_usage.sql"/>
  </changeSet>
  <changeSet id="7" author="markus">
    <sqlFile path="liquibase/drop_user_checklists.sql"/>
  </changeSet>
  <changeSet id="8" author="markus">
    <sqlFile path="liquibase/enum_update.sql"/>
  </changeSet>
  <changeSet id="9" author="markus">
    <sqlFile path="liquibase/extension_sync.sql"/>
  </changeSet>
  <changeSet id="10" author="markus">
    <sqlFile path="liquibase/extension_fks.sql"/>
  </changeSet>
  <changeSet id="11" author="markus">
    <sqlFile path="liquibase/name_index.sql"/>
  </changeSet>
  <changeSet id="12" author="markus">
    <sqlFile path="liquibase/issues.sql"/>
  </changeSet>
  <changeSet id="13" author="markus">
    <sqlFile path="liquibase/debug_views.sql"/>
  </changeSet>
  <changeSet id="14" author="markus">
    <sqlFile path="liquibase/hash_indeces.sql"/>
  </changeSet>
  <changeSet id="15" author="markus">
    <sqlFile path="liquibase/issue_metrics.sql"/>
  </changeSet>
  <changeSet id="16" author="markus">
    <sql>create index on name_usage (constituent_key);</sql>
  </changeSet>
  <changeSet id="17" author="markus">
    <sqlFile path="liquibase/rank_enum_update.sql"/>
  </changeSet>
  <changeSet id="18" author="markus">
    <sqlFile path="liquibase/debug_views.sql"/>
  </changeSet>
  <changeSet id="19" author="markus">
    <sql>ALTER TABLE raw_usage RENAME COLUMN smile TO data;</sql>
  </changeSet>
  <changeSet id="20" author="markus">
    <sql>
      ALTER TABLE name ADD CONSTRAINT scientific_name_unique UNIQUE (scientific_name);
      ALTER TABLE citation ADD CONSTRAINT citation_unique UNIQUE (citation);
    </sql>
  </changeSet>
  <changeSet id="21" author="markus">
    <sql>
      DROP VIEW kname;
      ALTER TABLE name_usage ALTER COLUMN origin type text;
      DROP TYPE origin_type;
      CREATE TYPE origin_type AS ENUM ('OTHER', 'SOURCE', 'DENORMED_CLASSIFICATION', 'VERBATIM_PARENT', 'VERBATIM_ACCEPTED', 'VERBATIM_BASIONYM', 'PROPARTE', 'AUTONYM', 'IMPLICIT_NAME', 'MISSING_ACCEPTED', 'AUTO_RECOMBINATION');
      ALTER TABLE name_usage ALTER COLUMN origin type origin_type USING (origin::origin_type);
    </sql>
    <sqlFile path="liquibase/debug_views.sql"/>
  </changeSet>
  <changeSet id="22" author="markus">
    <sql>CREATE INDEX ON name_usage (dataset_key, last_interpreted);</sql>
  </changeSet>
  <changeSet id="23" author="markus">
    <sql>
      ALTER TABLE citation DROP CONSTRAINT citation_unique;
      DROP INDEX citation_citation_idx;
      CREATE UNIQUE INDEX ON citation (md5(citation));

      DROP INDEX identifier_identifier_idx;
      CREATE UNIQUE INDEX ON identifier (identifier);
    </sql>
  </changeSet>
  <changeSet id="24" author="markus">
    <sql>
      ALTER TABLE name_usage_metrics DROP COLUMN count_descendants;
    </sql>
  </changeSet>
  <changeSet id="25" author="markus">
    <sql>
      ALTER TABLE name_usage ADD COLUMN deleted timestamp;
    </sql>
  </changeSet>

  <changeSet id="26" author="markus">
    <sql>
      ALTER TABLE dataset_metrics ADD COLUMN count_by_constituent hstore;
    </sql>
  </changeSet>
    <changeSet id="27" author="markus">
        <sql>
            CREATE INDEX ON name_usage (deleted) WHERE deleted IS NULL;
            DROP INDEX name_usage_constituent_key_idx;

            DROP INDEX name_usage_dataset_key_idx;
            CREATE INDEX ON name_usage (dataset_key) WHERE deleted IS NULL;

            DROP INDEX name_usage_dataset_key_idx1;
            CREATE INDEX ON name_usage (dataset_key) WHERE deleted IS NULL AND parent_fk IS NULL AND is_synonym = false;

            DROP INDEX name_usage_dataset_key_last_interpreted_idx;
            CREATE INDEX ON name_usage (dataset_key, last_interpreted) WHERE deleted IS NULL;

            DROP INDEX name_usage_dataset_key_taxon_id_idx;
            CREATE INDEX ON name_usage (dataset_key, taxon_id) WHERE deleted IS NULL;

            DROP INDEX name_usage_parent_fk_idx;
            CREATE INDEX ON name_usage (parent_fk) WHERE deleted IS NULL AND is_synonym=false;
            CREATE INDEX ON name_usage (parent_fk) WHERE deleted IS NULL AND is_synonym=true;
        </sql>
    </changeSet>
    <changeSet id="28" author="markus">
        <sql>
            DROP INDEX name_usage_dataset_key_taxon_id_idx;
            CREATE INDEX ON name_usage (dataset_key, taxon_id);
            <!-- add missing foreign key indexes on extension tables -->
            CREATE INDEX ON media (usage_fk);
            CREATE INDEX ON typification (usage_fk);
        </sql>
    </changeSet>
    <changeSet id="29" author="markus">
        <sql>
            DROP VIEW kname;

            ALTER TABLE name_usage ALTER COLUMN origin type text;
            DROP TYPE origin_type;
            CREATE TYPE origin_type AS ENUM ('OTHER', 'SOURCE', 'DENORMED_CLASSIFICATION', 'VERBATIM_PARENT', 'VERBATIM_ACCEPTED', 'VERBATIM_BASIONYM', 'PROPARTE', 'AUTONYM', 'IMPLICIT_NAME', 'MISSING_ACCEPTED', 'BASIONYM_PLACEHOLDER', 'AUTO_RECOMBINATION');
            ALTER TABLE name_usage ALTER COLUMN origin type origin_type USING (origin::origin_type);

            ALTER TABLE name ALTER COLUMN "type" type text;
            DROP TYPE name_type;
            UPDATE name SET "type"='SCIENTIFIC' WHERE "type"='SCINAME';
            UPDATE name SET "type"='SCIENTIFIC' WHERE "type"='WELLFORMED';
            UPDATE name SET "type"='NO_NAME' WHERE "type"='BLACKLISTED';
            CREATE TYPE name_type AS ENUM ('SCINAME', 'WELLFORMED', 'DOUBTFUL', 'BLACKLISTED', 'VIRUS', 'HYBRID', 'INFORMAL', 'CULTIVAR', 'CANDIDATUS');
            CREATE TYPE name_type AS ENUM ('SCIENTIFIC', 'VIRUS', 'HYBRID', 'INFORMAL', 'CULTIVAR', 'CANDIDATUS', 'DOUBTFUL', 'PLACEHOLDER', 'NO_NAME');
            ALTER TABLE name ALTER COLUMN "type" type name_type USING ("type"::name_type);
        </sql>
        <sqlFile path="liquibase/debug_views.sql"/>
    </changeSet>
    <changeSet id="30" author="markus">
        <sql>
            CREATE INDEX ON name_usage (basionym_fk) WHERE deleted IS NULL;
        </sql>
    </changeSet>

</databaseChangeLog>
